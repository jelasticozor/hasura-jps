stages:
  - publish-docker
  - test
  - report

variables:
  HASURA_TEST_IMAGE: softozor/hasura-jps-test

.docker-login: &docker-login
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

.docker-push: &docker-push
  - docker push $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA
  - docker push $DOCKER_IMAGE:latest

publish-feature-test-image:
  stage: publish-docker
  image: docker:latest
  variables:
    DOCKER_IMAGE: ${HASURA_TEST_IMAGE}
    DOCKERFILE_FOLDER: ./ci/feature-tests
  before_script:
    - *docker-login
  script:
    - |
      docker build $DOCKERFILE_FOLDER -t $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA -t $DOCKER_IMAGE:latest \
        --build-arg FAAS_CLI_VERSION=${FAAS_CLI_VERSION} \
        --build-arg HASURA_CLI_VERSION=${HASURA_CLI_VERSION} \
        --build-arg PERSONAL_ACCESS_TOKEN=${PRIVATE_ACCESS_TOKEN} \
        --build-arg CI_API_V4_URL=${CI_API_V4_URL} \
        --build-arg FAAS_CLIENT_PYPI_PROJECT_ID=${FAAS_CLIENT_PYPI_PROJECT_ID}
    - *docker-push
  only:
    changes:
      - ci/feature-tests/*

publish-faas-image:
  stage: publish-docker
  image: docker:latest
  variables:
    DOCKER_IMAGE: softozor/ubuntu-git
    DOCKERFILE_FOLDER: ./ci/ubuntu
  before_script:
    - *docker-login
  script:
    - docker build $DOCKERFILE_FOLDER -t $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA -t $DOCKER_IMAGE:latest
    - *docker-push
  only:
    refs:
      - master
    changes:
      - ci/ubuntu/Dockerfile

publish-faas-functions:
  stage: publish-docker
  image: softozor/faas-cli:${TOOLS_SHA}
  before_script:
    - *docker-login
  script:
    - cd ${CI_PROJECT_DIR}/features/data/functions
    - faas-cli build -f ./faas.yml
    - faas-cli push -f ./faas.yml
  only:
    refs:
      - master
    changes:
      - features/data/functions/**/*

acceptance-test:
  stage: test
  image: ${HASURA_TEST_IMAGE}:latest
  script:
    - |
      behave --junit --junit-directory ./features/test-reports --tags ~wip \
        -D project-root-folder="${CI_PROJECT_DIR}" \
        -D api-url="${JELASTIC_API_URL}" \
        -D api-token="${JELASTIC_ACCESS_TOKEN}" \
        -D commit-sha="${CI_COMMIT_SHORT_SHA}" \
        -D base-url="http://${CI_SERVER_HOST}/${CI_PROJECT_PATH}/-/raw/${CI_COMMIT_REF_NAME}"
  artifacts:
    reports:
      junit:
        - $CI_PROJECT_DIR/features/test-reports/*.xml
    paths:
      - $CI_PROJECT_DIR/features/test-reports/*.xml

publish-pickles:
  stage: report
  image: softozor/pickles:2.21.1
  variables:
    APPLICATION_NAME: hasura-jps
    OUTPUT_DIR: $CI_PROJECT_DIR/pickles
  script:
    - |
      mono /pickles/Pickles.exe --feature-directory=. \
        --output-directory=${OUTPUT_DIR} \
        --system-under-test-name=${APPLICATION_NAME} \
        --system-under-test-version=$CI_COMMIT_SHORT_SHA \
        --documentation-format=dhtml \
        --language=en --exp --et 'wip' --enableComments=false
  artifacts:
    paths:
      - $OUTPUT_DIR