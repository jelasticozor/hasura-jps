stages:
  - publish-docker
  - test

publish-faas-image:
  stage: publish-docker
  image: docker:latest
  variables:
    DOCKER_IMAGE: softozor/faasd
    DOCKERFILE_FOLDER: ./ci/ubuntu
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build $DOCKERFILE_FOLDER -t $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA -t $DOCKER_IMAGE:latest
    - docker push $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $DOCKER_IMAGE:latest
  only:
    refs:
      - master
#    changes:
#      - $CI_PROJECT_DIR/ci/ubuntu/*

acceptance-test:
  stage: test
  image: softozor/python-infrastructure-tests:${TOOLS_SHA}
  script:
    - |
      behave --junit --junit-directory ./features/test-reports --tags ~wip \
        -D project-root-folder="${CI_PROJECT_DIR}" \
        -D api-url="${JELASTIC_API_URL}" \
        -D api-token="${JELASTIC_ACCESS_TOKEN}" \
        -D commit-sha="${CI_COMMIT_SHORT_SHA}"
  artifacts:
    reports:
      junit:
        - $CI_PROJECT_DIR/features/test-reports/*.xml
    paths:
      - $CI_PROJECT_DIR/features/test-reports/*.xml
