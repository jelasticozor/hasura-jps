stages:
  - publish-docker
  - test

.docker-login: &docker-login
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

publish-faas-image:
  stage: publish-docker
  image: docker:latest
  variables:
    DOCKER_IMAGE: softozor/ubuntu-git
    DOCKERFILE_FOLDER: ./ci/ubuntu
  before_script:
    - *docker-login
  script:
    - docker build $DOCKERFILE_FOLDER -t $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA -t $DOCKER_IMAGE:latest
    - docker push $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $DOCKER_IMAGE:latest
  only:
    refs:
      - master

publish-faas-functions:
  stage: publish-docker
  image: softozor/faas-cli:${TOOLS_SHA}
  before_script:
    - *docker-login
  script:
    - cd ${CI_PROJECT_DIR}/features/data/functions
    - faas-cli build -f ./faas.yml
    - faas-cli push -f ./faas.yml
  # TODO: only call if the folder has changed sources

acceptance-test:
  stage: test
  image: softozor/python-infrastructure-tests:${TOOLS_SHA}
  before_script:
    - *docker-login
  script:
    - |
      behave --junit --junit-directory ./features/test-reports --tags ~wip \
        -D project-root-folder="${CI_PROJECT_DIR}" \
        -D api-url="${JELASTIC_API_URL}" \
        -D api-token="${JELASTIC_ACCESS_TOKEN}" \
        -D commit-sha="${CI_COMMIT_SHORT_SHA}"
  artifacts:
    reports:
      junit:
        - $CI_PROJECT_DIR/features/test-reports/*.xml
    paths:
      - $CI_PROJECT_DIR/features/test-reports/*.xml
