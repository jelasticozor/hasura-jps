type: update
name: hasura

settings:
  fields:
    - type: spacer
      caption: Faas
    - name: faasHostname
      caption: Hostname
      type: string
      required: true
    - name: faasPort
      caption: Port
      type: string
      required: true
    - type: spacer
      caption: Database
    - name: dbUsername
      caption: Database username
      type: string
      required: true
    - name: dbPassword
      caption: Database password
      type: string
      inputType: password
      required: true
    - name: dbName
      caption: Database name
      type: string
      required: true
    - type: spacer
      caption: Hasura
    - name: enableConsole
      caption: Enable console
      type: checkbox
      value: true
    - name: adminSecret
      caption: Admin secret
      type: string
      inputType: password
      required: true
    - name: unauthorizedRole
      caption: Unauthorized role
      type: string
      default: anonymous
    - name: serverPort
      caption: Server port
      type: string
      default: 8080

onInstall:
  - forEach(nodes.cp):
    - api:
        - method: environment.control.SetContainerEnvVars
          params:
            nodeId: ${@i.id}
            vars:
              HASURA_GRAPHQL_DATABASE_URL: postgres://${settings.dbUsername}:${settings.dbPassword}@${nodes.sqldb.master.intIP}:5432/${settings.dbName}
              HASURA_GRAPHQL_ENABLE_CONSOLE: ${settings.enableConsole}
              HASURA_GRAPHQL_ADMIN_SECRET: ${settings.adminSecret}
              HASURA_GRAPHQL_UNAUTHORIZED_ROLE: ${settings.unauthorizedRole}
              HASURA_GRAPHQL_SERVER_PORT: ${settings.serverPort}
              FAAS_HOSTNAME: ${settings.faasHostname}
              FAAS_PORT: ${settings.faasPort}
  - cmd[cp]:
      - firewall-cmd --permanent --add-port=${settings.serverPort}/tcp
      - firewall-cmd --reload
  - restartContainers[cp]