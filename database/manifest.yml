type: update
name: database
baseUrl: http://gitlab.hidora.com/softozor/hasura-jps/-/raw/master

settings:
  fields:
    - name: adminUsername
      caption: Admin username
      type: string
      required: true
    - name: adminPassword
      caption: Admin password
      type: string
      inputType: password
      required: true
    - name: databaseName
      caption: Database name
      type: string
      required: true
    - name: username
      caption: Username
      type: string
      required: true
    - name: password
      caption: Password
      type: string
      inputType: password
      required: true

onInstall:
- cmd[${nodes.sqldb.master.id}]:
  - |
    export PGPASSWORD=${settings.adminPassword}
    psql -U ${settings.adminUsername} -d postgres -c "CREATE USER ${settings.username} PASSWORD '${settings.password}';"
    psql -U ${settings.adminUsername} -d postgres -c "CREATE DATABASE ${settings.databaseName} OWNER ${settings.username} ENCODING 'utf-8' TEMPLATE template0;"
    wget --quiet ${baseUrl}/database/setup.sql -O setup.sql
    sed -i s/DATABASE_USER/${settings.username}/g setup.sql
    psql -U ${settings.adminUsername} -d ${settings.databaseName} -f setup.sql
