type: install
name: Jelasticozor infrastructure
baseUrl: http://gitlab.hidora.com/softozor/hasura-jps/-/raw/master/

settings:
  fields:
    - type: spacer
      caption: Hasura
    - name: hasuraVersion
      caption: Hasura version
      type: string
      default: v2.0.9
    - name: enableHasuraConsole
      caption: Enable console
      type: checkbox
      value: true
    - name: hasuraUnauthorizedRole
      caption: Unauthorized role
      type: string
      default: anonymous

globals:
  DB_ADMIN_USERNAME: webadmin
  DB_NAME: hasura
  DB_USERNAME: hasura_user
  DB_PASSWORD: ${fn.password(20)}
  HASURA_ADMIN_SECRET: ${fn.password(20)}
  HASURA_SERVER_PORT: 8080

nodes:
- count: 1
  cloudlets: 4
  nodeGroup: bl
  nodeType: nginx-dockerized
- displayName: faasd
  count: 1
  cloudlets: 16
  nodeGroup: faas
  nodeType: docker
  image: softozor/ubuntu-git:latest
- displayName: database
  count: 2
  fixedCloudlets: 3
  cloudlets: 32
  nodeType: postgres13
  scalingMode: STATELESS
  password: ${fn.password}
  cluster: true
- displayName: hasura
  count: 1
  cloudlets: 32
  nodeGroup: cp
  nodeType: docker
  image: hasura/graphql-engine:${settings.hasuraVersion}.centos
skipNodeEmails: true

onInstall:
  - installFaas
  - installDatabase
  - installHasura
  - installLoadBalancer

actions:
  installFaas:
    install:
      jps: serverless/manifest.yml
  installDatabase:
    install:
      jps: database/manifest.yml
      settings:
        adminUsername: ${globals.DB_ADMIN_USERNAME}
        adminPassword: ${nodes.sqldb.password}
        databaseName: ${globals.DB_NAME}
        username: ${globals.DB_USERNAME}
        password: ${globals.DB_PASSWORD}
  installHasura:
    install:
      jps: hasura/manifest.yml
      settings:
        dbUsername: ${globals.DB_USERNAME}
        dbPassword: ${globals.DB_PASSWORD}
        dbName: ${globals.DB_NAME}
        enableConsole: ${settings.enableHasuraConsole}
        adminSecret: ${globals.HASURA_ADMIN_SECRET}
        unauthorizedRole: ${settings.hasuraUnauthorizedRole}
        serverPort: ${globals.HASURA_SERVER_PORT}
  installLoadBalancer:
    install:
      jps: bl/manifest.yml
      settings:
        serverPort: ${globals.HASURA_SERVER_PORT}

success:
  text: |
    **Hasura Console**: [${env.protocol}://${env.domain}/](${env.protocol}://${env.domain}/)  
    **Hasura Admin Secret**: ${globals.HASURA_ADMIN_SECRET}  
    **Database Admin Panel**: [${nodes.sqldb.master.url}](${nodes.sqldb.master.url})  
    **Database Admin User**: ${globals.DB_ADMIN_USERNAME}  
    **Database Admin Password**: ${nodes.sqldb.password}  
    **Database Name**: ${globals.DB_NAME}  
    **Database Username**: ${globals.DB_USERNAME}  
    **Database Password**: ${globals.DB_PASSWORD}