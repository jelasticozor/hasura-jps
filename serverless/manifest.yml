type: update
name: faasd
baseUrl: https://gitlab.hidora.com/softozor/hasura-jps/-/raw/master

settings:
  fields:
    - type: spacer
      caption: IAM Service
    - name: authApiKey
      caption: Auth API Key
      inputType: password
      type: string
      required: true
    - name: authUrl
      caption: Auth URL
      type: string
      required: true
    - type: spacer
      caption: Misc
    - name: fncTag
      caption: Docker tag
      type: string
      required: true
    - type: spacer
      caption: Logs Aggregation
    - name: logsAggregatorHost
      caption: Host
      type: string
    - name: logsAggregatorPort
      caption: Port
      type: string

onInstall:
  - installEngine
  - deployAuthFunctions

actions:
  installEngine:
    - cmd[faas]:
        - systemctl start containerd
        - cd /faasd-installation
        - /usr/local/bin/faasd install
  deployAuthFunctions:
    - cmd[faas]:
        - wget -q ${baseUrl}/serverless/functions/fusionauth.yml -O /faas-template/fusionauth.yml
    - api:
        - method: environment.control.ExecCmdByGroup
          params:
            nodeGroup: faas
            commandList:
              - command: while ! nc -z localhost 8080 ; do sleep 1 ; done
              - command: cat /var/lib/faasd/secrets/basic-auth-password | faas-cli login -u admin --password-stdin
              - command: faas-cli secret create auth-secret --from-literal "${settings.authApiKey}"
              - command: cd /faas-template
              - command: IMG_TAG=${settings.fncTag} AUTH_URL=${settings.authUrl} LOGS_AGGREGATOR_HOST=${settings.logsAggregatorHost} LOGS_AGGREGATOR_PORT=${settings.logsAggregatorPort} faas-cli deploy -f fusionauth.yml

description: |
  We install faasd, a lightweight & portable faas engine.

success: serverless/successText.md

logo: https://raw.githubusercontent.com/openfaas/faasd/master/docs/media/social.png
homepage: https://github.com/openfaas/faasd
