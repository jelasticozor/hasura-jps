type: update
name: faasd
baseUrl: http://gitlab.hidora.com/softozor/hasura-jps/-/raw/master

settings:
  fields:
    - name: authApiKey
      caption: Auth API Key
      inputType: password
      type: string
      required: true
    - name: dataProtectionSecretKey
      caption: Data Protection Secret Key
      inputType: password
      type: string
      required: true
    - name: authUrl
      caption: Auth URL
      type: string
      required: true

onInstall:
  - installDiagnosticTools
  - installEngine
  - waitUntilEngineIsUp
  - pullTemplatesForFunctionDeployment
  - deployAuthFunctions

actions:
  installDiagnosticTools:
    - cmd[faas]:
        - apt update -y && apt install -y netcat
  installEngine:
    - cmd[faas]:
        - git clone https://github.com/openfaas/faasd
        - cd faasd
        - ./hack/install.sh
  waitUntilEngineIsUp:
    - cmd[faas]:
        - while ! nc -z localhost 8080 ; do sleep 1 ; done
  pullTemplatesForFunctionDeployment:
    - cmd[faas]:
        - faas-cli template pull
        - faas-cli template pull http://gitlab.hidora.com/softozor/faas-templates.git
  deployAuthFunctions:
    - forEach(nodes.faas):
        - api:
            - method: environment.control.SetContainerEnvVars
              params:
                nodeId: ${@i.id}
                vars:
                  AUTH_URL: ${settings.authUrl}
                  HASURA_CLAIMS_NAMESPACE: https://hasura.io/jwt/claims
    - cmd[faas]:
        - cat /var/lib/faasd/secrets/basic-auth-password | faas-cli login -u admin --password-stdin
        - faas-cli secret create auth-secret --from-literal "${settings.authApiKey}"
        - faas-cli secret create data-protection-secret --from-literal "${settings.dataProtectionSecretKey}"
        - wget -q ${baseUrl}/serverless/functions/fusionauth.yml
        - faas-cli deploy -f fusionauth.yml

description: |
  We install faasd, a lightweight & portable faas engine.

success: serverless/successText.md

logo: https://raw.githubusercontent.com/openfaas/faasd/master/docs/media/social.png
homepage: https://github.com/openfaas/faasd
