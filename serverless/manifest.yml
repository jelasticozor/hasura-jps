type: update
name: faasd
baseUrl: https://gitlab.hidora.com/softozor/hasura-jps/-/raw/master

settings:
  fields:
    - type: spacer
      caption: IAM Service
    - name: authApiKey
      caption: Auth API Key
      inputType: password
      type: string
      required: true
    - name: authUrl
      caption: Auth URL
      type: string
      required: true
    - type: spacer
      caption: Misc
    - name: fncTag
      caption: Docker tag
      type: string
      required: true
    - type: spacer
      caption: Logs Aggregation
    - name: logsAggregatorHost
      caption: Host
      type: string
    - name: logsAggregatorPort
      caption: Port
      type: string
    - type: spacer
      caption: Docker Hub
    - name: useAnonymousDockerHubAccount
      type: toggle
      caption: Use Anonymous Docker Hub
      value: true
      hidden: false
      showIf:
        false:
          - name: dockerHubUser
            caption: Username
            type: string
            required: true
          - name: dockerHubPassword
            caption: Password
            type: string
            inputType: password
            required: true

onInstall:
  - installEngine
  - waitUntilEngineIsUp
  - pullTemplatesForFunctionDeployment
  - setCommonEnvVars
  - deployAuthFunctions

actions:
  installEngine:
    # TODO: we should not install the engine like this, because we kind of use systemd in a docker container
    - cmd[faas]:
        - git clone https://github.com/openfaas/faasd
        - cd faasd
        - ./hack/install.sh
  waitUntilEngineIsUp:
    - cmd[faas]:
        # TODO: use execCmdByGroup
        - while ! nc -z localhost 8080 ; do sleep 1 ; done
  pullTemplatesForFunctionDeployment:
    - cmd[faas]:
        - faas-cli template pull
        - faas-cli template pull https://gitlab.hidora.com/softozor/faas-templates.git
  setCommonEnvVars:
    - api:
        - method: environment.control.AddContainerEnvVars
          params:
            nodeGroup: faas
            vars:
              IMG_TAG: ${settings.fncTag}
              LOGS_AGGREGATOR_HOST: ${settings.logsAggregatorHost}
              LOGS_AGGREGATOR_PORT: ${settings.logsAggregatorPort}
  deployAuthFunctions:
    - api:
        - method: environment.control.AddContainerEnvVars
          params:
            nodeGroup: faas
            vars:
              AUTH_URL: ${settings.authUrl}
    - cmd[faas]:
        - if (!${settings.useAnonymousDockerHubAccount}):
          - docker login -u ${settings.dockerHubUser} -p ${settings.dockerHubPassword}
        - cat /var/lib/faasd/secrets/basic-auth-password | faas-cli login -u admin --password-stdin
        - faas-cli secret create auth-secret --from-literal "${settings.authApiKey}"
        - wget -q ${baseUrl}/serverless/functions/fusionauth.yml
        - faas-cli deploy -f fusionauth.yml

description: |
  We install faasd, a lightweight & portable faas engine.

success: serverless/successText.md

logo: https://raw.githubusercontent.com/openfaas/faasd/master/docs/media/social.png
homepage: https://github.com/openfaas/faasd
