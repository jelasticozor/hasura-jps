type: update
name: load balancer
baseUrl: http://gitlab.hidora.com/softozor/hasura-jps/-/raw/master

targetNodes:
  nodeGroup:
    - bl

# TODO: find out why this does not work
#settings:
#  fields:
#    - name: externalDomains
#      caption: External domain names (;-separated list)
#      type: string
#      vtype: domainlist
#      required: true

onInstall:
  - installAddon:
      id: letsencrypt
  - redirectHttpToHttps
  - restartContainers[bl]

actions:
  redirectHttpToHttps:
    - cmd [bl]:
        - wget ${baseUrl}/bl/main-server.conf -O /etc/nginx/conf.d/main-server.conf
      user: root
    - cmd [bl]:
        - cd /etc/nginx
        - cp nginx-jelastic.conf nginx-jelastic.conf.bak
        - out=$(head -n -6 nginx-jelastic.conf; echo "END_MARKER" ; tail -6 nginx-jelastic.conf); echo "$out" > nginx-jelastic.conf
        - sed -i -e '/GFADMIN/,/END_MARKER/!b' -e '/END_MARKER/!d' -e 'd' nginx-jelastic.conf
      user: root

addons:
  - id: letsencrypt
    name: letsencrypt
    onInstall:
      - install [bl]:
          envName: ${env.envName}
          jps: https://github.com/jelastic-jps/lets-encrypt/blob/master/manifest.jps
          settings:
            customDomains: ${env.envName}.hidora.com
