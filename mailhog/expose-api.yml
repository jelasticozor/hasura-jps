type: update
name: Expose Mailhog API
baseUrl: https://gitlab.hidora.com/softozor/hasura-jps/-/raw/master

settings:
  fields:
    - name: mailServerHost
      caption: Host
      type: string
      required: true
    - name: fncTag
      caption: Docker tag
      type: string
      required: true

globals:
  MAIL_SERVER_API_PORT: 8025

onInstall:
  - setupMailhogActions
  - deployMailhogFunctions

actions:
  setupMailhogActions:
    - cmd[cp]:
        - wget ${baseUrl}/mailhog/actions.graphql -O actions.graphql
        - cat actions.graphql >> /hasura-metadata/actions.graphql
    - cmd[cp]:
        - wget ${baseUrl}/mailhog/setup_actions.py -O setup_actions.py
        - python3 ./setup_actions.py --actions-yaml /hasura-metadata/actions.yaml
  deployMailhogFunctions:
    - cmd[faas]:
        - cd /faas-template
        - wget -q ${baseUrl}/serverless/functions/mailhog.yml
    - api:
        - method: environment.control.ExecCmdByGroup
          params:
            nodeGroup: faas
            commandList:
              - command: while ! nc -z localhost 8080 ; do sleep 1 ; done
              - command: cat /var/lib/faasd/secrets/basic-auth-password | faas-cli login -u admin --password-stdin
              - command: cd /faas-template
              - command: IMG_TAG=${settings.fncTag} MAIL_SERVER_HOST=${settings.mailServerHost} MAIL_SERVER_API_PORT=${globals.MAIL_SERVER_API_PORT} faas-cli deploy -f mailhog.yml
